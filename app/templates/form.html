{% extends "base.html" %}
{% block page_includes -%}
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/form.css') }}" />
	<script type="text/javascript" src="{{ url_for('static', filename='js/form.js') }}"></script>
	<script type="text/javascript">
		"use strict";
		var formLevels = [
			{% for level in accesslevels -%}
			'{{ level.name }}',
			{% endfor -%}
		];
		var formLevelIndex = '{{ accesslevel_index }}';
		var formLevel      = formLevels[formLevelIndex];
		var userLevel      = '{{ user_accesslevel_index }}';

		var Config = {
			hideDisabledComponents: true
		};
	</script>
{% endblock -%}
{% macro render_buttonset(component) -%}
{# Renders the reset, add and remove buttons for a block or parameter -#}
<i title="Reset to default value ('{{ component.default }}')" class="reset fa fa-fw fa-undo
	{#-
		Don't allow entire blocks to be reset with a single click.
		This could be supported actually, but I'd rather not implement it
		because one misclick could mean a lot of lost parameters and a lot of
		unhappy researchers.
	-#}
{%-
	if component.type == 'block' or (component.type == 'parameter' and component.datatype == 'file')
		or True
-%}
	{#-
		Actually, we can always start with an invisible reset button; We should
		enable it onChange.
	-#}
	{# (force printing of the space to the left of invisible) #} invisible
{%- endif -%}
"></i>{# -#}
<i class="minus fa fa-fw fa-minus
	{#- -#}
	{#-
		On page load we always generate the minimum amount of objects;
		The user shouldn't be able to remove anything they did not add themselves.
	-#}
	{# (force printing of the space to the left of invisible) #} invisible
	{#- -#}
"></i>{# -#}
<i class="plus fa fa-fw fa-plus
	{#- -#}
	{#- But we do need to check whether the user is allowed to add more stuff -#}
	{%- if not component.repeat or component.repeat_min == component.repeat_max -%}
		{# (force printing of the space to the left of invisible) #} invisible
	{%- endif -%}
	{#- -#}
"></i>{# -#}

{% endmacro -%}
{% block content -%}
<section class="content-form">
	<header>
		<h1>HADDOCK Form</h1>
	</header>

	<noscript>
		<div class="warning">
			<p><i class="fa fa-warning"></i>
				JavaScript appears to be disabled in your browser. <br />
				This web application requires JavaScript to enable multiplication of input fields,
				section folding and form level selection, and will not work correctly without it.
				Please enable JavaScript support or use a different browser.
			</p>
		</div>
	</noscript>

	<ul class="levelchooser">
		{% for level in accesslevels %}
		<li class="level-{{ level.name }}
				{%- if level.name == accesslevels[accesslevel_index].name %} selected{% endif %}
				{%- if loop.index0 > user_accesslevel_index %} too-high{% endif %}"
				style="width: {{ 100 / (accesslevels | length) }}%"
				data-name="{{ level.name }}"
				data-index="{{ loop.index0 }}"
			>
			{{ level.label }}
		</li>
		{% endfor -%}
	</ul>

	<div class="levelwarning warning hidden"></div>

	<form id="haddockform" class="nice div60" method="post">
	{% for component in model recursive -%}
		<div class="row
			{%- for level in component.accesslevels -%}
				{# #} level-{{ level }}
			{%- endfor -%}">
		{% if component.type == 'block' -%}
			{# Open a new block -#}
			<section>
				<header>
					<i class="togglebutton fa fa-fw fa-lg fa-angle-double-down"></i>
					<span class="header-text">{{ component.label }}</span>
					<div class="buttonset block-buttons float-right">
					{{ render_buttonset(component) -}}
					</div>
				</header>
				<div class="content">
					{# Loop recursively in the content div -#}
					{{ loop(component.children) -}}
				</div>
			</section>
		{% elif component.type == 'parameter' -%}
			{# Output a parameter -#}
			{# First render a label with the correct for attribute -#}
			<label for="f_{{ component.name }}" title="[{{ component.accesslevel }}] ({{ component.datatype }}) {{ component.name }}">{{ component.label or component.name }}</label>
			<div class="value">
			{% if component.datatype == 'choice' -%}
				{# For choice parameters, render radio buttons or a dropdown depending on the amount of options -#}
				{% if component.options | length > config.FRONTEND_RADIO_MAX -%}
					<select class="parameter" id="f_{{ component.name }}" name="{{ component.name }}" data-default="{{ component.default }}">
					{% for option in component.options -%}
						<option value="{{ option }}"{% if component.default == option %} selected{% endif %}>{{ option }}</option>
					{% endfor -%}
					</select>
				{% else -%}
					{# Render radio buttons instead -#}
					{# The default value is stored in a data attribute in a container div -#}
					<div id="f_{{ component.name }}" class="checkgroup" data-default="{{ component.default }}">
					{% for option in component.options -%}
						<input class="parameter" id="f_{{ component.name }}_{{ loop.index}}" value="{{ option }}" name="{{ component.name }}" type="radio"{% if component.default == option %} checked{% endif %} />
						<label for="f_{{ component.name }}_{{ loop.index}}">{{ option }}</label>
					{% endfor -%}
					</div>
				{% endif -%}
			{% else -%}
				{# Default to a normal text input -#}
				{# Select a HTML5 input pattern restriction based on the data type -#}
				{% if component.datatype == 'integer' -%}
					{% set pattern = '\d*' -%}
				{% elif component.datatype == 'float' -%}
					{# FIXME: This pattern is not strict enough at all -#}
					{% set pattern = '[0-9.]*' -%}
				{% endif -%}
				<input class="parameter" id="f_{{ component.name }}" name="{{ component.name }}" type="text" value="{{ component.default }}"
					{%- if pattern %} pattern="{{ pattern }}"{% endif %} data-default="{{ component.default }}" />
			{% endif -%}
				<div class="buttonset parameter-buttons" data-for="f_{{ component.name }}">
				{{ render_buttonset(component) -}}
				</div>
			</div>
		{% elif component.type == 'paragraph' -%}
			<p class="documentation">
				{{ component.text }}
			</p>
		{% endif -%}
		</div>
	{% endfor -%}
	<div class="align-center">
		<input type="submit" />
	</div>
	</form>
</section>
{% endblock %}
